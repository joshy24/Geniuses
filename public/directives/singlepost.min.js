myApp.directive("singlePost",["$compile","$sce","$state","service","postChange","responseReview","storageService","authService",function(e,t,n,i,o,s,c,a){function C(e,t){return e.indexOf(t)>=0}var g,_,u=function(e){e=e.trim();var t=e.split(" ")[0],n=e.split(" ")[1],i=t.split("-")[2],o=t.split("-")[1],s=t.split("-")[0],c=new Date,a=c.getDate(),u=c.getMonth()+1,l=c.getFullYear();if(s==l){if(o==u){if(i==a){post_hour=n.split(":")[0],post_min=n.split(":")[1],post_sec=n.split(":")[2];var r=new Date;return hour=r.getHours(),min=r.getMinutes(),sec=r.getSeconds(),hour==post_hour?min==post_min?sec==post_sec?"just now":sec-post_sec<=30?"just now":(sc=sec-post_sec,sc+" seconds ago"):min-post_min==1?"1 minute ago":(mn=min-post_min,mn+" minutes ago"):hour-post_hour==1?"1 hour ago":(hr=hour-post_hour,hr+" hours ago")}return a-i==1?"1 day ago":(dy=a-i,dy+" days ago")}return u-o==1?"1 month ago":(mn=u-o,mn+" months ago")}return l-s==1?"1 year ago":(yr=l-s,yr+" years ago")},h='<div class="col-xs-12 col-md-12"><h5 ng-hide="is_image_question" class="post-info-text" ng-bind-html="getHtml(question)" id="question-text"></h5><img ng-show="is_image_question" class="timeline-image-question" ng-src="{{image_question}}"></div><div class="col-xs-12 col-md-12"><img class="pull-right" ng-src="images/SSCE/{{subject_name}}/Images/{{question_image}}" id="question-image"></div>',v='<div class="col-xs-12 col-md-12"> <h5 ng-hide="is_image_question" class="post-info-text" ng-bind-html="getHtml(question)" id="question-text"></h5><img ng-show="is_image_question" class="timeline-image-question" ng-src="{{image_question}}"></div>',q="",w=function(){_='<div class="allcomments"><div ng-show="isLoggedIn" class="col-xs-12 col-sm-12 col-md-12"><button ng-click="refreshComments()" id="refresh-comments-btn"><img src="img/reload.png" height="30" width="30"> refresh comments</button></div><div ng-repeat="comment in comments"><div class="container-fluid"><div class="row comment-info-div col-md-12"><a ng-click="showProfile(comment.user_id)"><img class="pull-left img-circle" ng-src="{{comment.picture_url}}" id="owner-image" height="40" width="40"></a><div class="row"><a ng-click="showProfile(comment.user_id)"><h5 class="capitalize post-info-text pull-left" id="owner-name"><b>{{comment.firstname}}  {{comment.lastname}}</b></h5></a><h5 class="post-info-text" id="post-date">{{comment.created}}</h5></div> </div><div class="row"><div ng-hide="isEdittedClicked && comment.user_id==user_id && current_editted_id==$index" class="col-xs-12 col-md-12"><h5 class="post-info-text" id="comment-text"><b>{{comment.comment}}</b></h5> </div> <div ng-show="isLoggedIn && isEdittedClicked && comment.user_id==user_id && current_editted_id==$index" class="col-xs-11 col-md-11"><textarea class="post-info-text" id="edit-text" ng-model="edited_comment">{{edited_comment}}</textarea></div><div ng-show="!isEdittedClicked && comment.user_id==user_id &&isLoggedIn" class="col-xs-12 col-md-12"><button ng-click="setEdittedClicked(true, comment.comment, $index)" class="abtn"><img src="img/edit.png" height="30" width="30"> edit</button></div><div ng-show="isEdittedClicked && comment.user_id==user_id && current_editted_id==$index && isLoggedIn" class="col-xs-12 col-md-12"><div id="edit-buttons-div"><button ng-click="submitEditted(edited_comment, comment.comment_id)" class="abtn"><img src="img/post.png" height="30px" width="30px"> submit</button> <button class="abtn" ng-click="unsetEdittedClicked()"><img src="img/close.png" height="30px" width="30px"> cancel</button></div></div></div></div></div></div>'},b=function(e,t){var n="";return null!=e&&0!=e?n='<div class="post-single"><div class="container-fluid"><div class="row post-owner-info-div"><h5 class="text-center">posted by <img ng-src="{{owner_image}}" height="40" width="40" class="img-circle"> <b>{{owner_name}}</b> on {{created}}</h5></div></div><div class="row">'+q+'</div><div class="row options-info-div"><div class="col-xs-6 col-md-6"><h5 ng-bind-html="getHtml(optionA)" class="question-option"></h5></div><div class="col-xs-6 col-md-6"><h5 ng-bind-html="getHtml(optionB)" class="question-option"></h5></div><div class="col-xs-6 col-md-6"><h5 ng-bind-html="getHtml(optionC)" class="question-option"></h5></div><div class="col-xs-6 col-md-6"><h5 ng-bind-html="getHtml(optionD)" class="question-option"></h5></div></div> <div class="row explanation-info-div col-md-12"> <img class="pull-left" ng-src="{{llh_img}}" id="llh-image" height="40" width="40"> <div class="row">  <h5 class="post-info-text" id="llh-name"><b>Explanation by Team LLH</b></h5> </div>   </div> <div class="row"> <div class="col-xs-12 col-md-12 question-answer-div"><b><h5 ng-bind-html="getHtml(answer_text)" class="pull-left question-answer"></h5></b></div> <div class="col-xs-11 col-md-11 explanation-content-div"><h5 class="post-info-text" id="explanation-text-sinlge" ng-bind-html="getHtml(explanation)"></h5><img id="question-explanation-img" ng-src="{{explanation_image}}"></div>  </div> <div class="row"> <div class="question-interaction-div col-md-12 col-xs-12"><div class="single-interaction"><button data-toggle="tooltip" title="click if explanation was helpful" ng-click="incrementHelpful()" class="text-center"><img src="{{helpful_img}}" height="25" width="25"> like</button><h6 class="text-center">{{helpful_count}}</h6></div><div class="single-interaction"><button data-toggle="tooltip" title="click to share this post" ng-click="incrementShare()" class="text-center"><img src="img/share-two.png" height="25" width="25"> share</button><h6 ng-model="share_count" class="text-center">{{share_count}}</h6></div><div class="single-interaction"><h5 class="text-center" data-toggle="tooltip" title="number of times this post has been viewed"><img src="img/views.png" height="25" width="25"> views</h5><h6 class="text-center">{{views_count}}</h6></div><div class="single-interaction"><h5 data-toggle="tooltip" title="total number of comments on this post" class="text-center"><img src="img/comment.png" height="25" width="25"> comments</h5><h6 class="text-center">{{comment_count}}</h6></div></div></div> </div>  <div class="user-comment-div"><div class="container-fluid"><div class="row user-info-div col-md-12"><a ng-click="showProfile(user_id)"><img class="pull-left img-circle" ng-src="{{user_img}}" id="user-image" height="40" width="40"></a><div class="row"><h5 class="capitalize post-info-text" id="user-name"><b>{{user_name}}</b></h5></div> </div><div class="row"><div class="col-xs-10 col-md-11 post-comment-div"><textarea class="post-info-text" placeholder="comment on this post" id="user-comment-text" ng-model="acomment">{{acomment}}</textarea></div> <div class="col-md-12 col-xs-12"><button ng-click="makeComment()" id="post-btn"><img src="img/post.png" height="25" width="25"> post</button></div> </div>  </div></div>'+_:null!=t&&0!=t&&(n='<div class="discussion-post-div"><div class="container-fluid"><div class="row post-owner-info-div"><h5 class="text-center">posted by <img ng-src="{{owner_image}}" height="40" width="40" class="img-circle"> <b>{{owner_name}}</b> on {{created}}</h5></div><div class="row"><div class="col-xs-10 col-md-11"><h5 class="post-info-text" id="discussion-comment-text"><b>{{discussion}}</b></h5></div> </div> </div></div> <div class="user-comment-div"><div class="container-fluid"><div class="row user-info-div col-md-12"><a ng-click="showProfile(user_id)"><img class="pull-left img-circle" ng-src="{{user_img}}" id="user-image" height="40" width="40"></a><div class="row"><h5 class="capitalize post-info-text" id="user-name"><b>{{user_name}}</b></h5></div> </div><div class="row"><div class="col-xs-10 col-md-11 post-comment-div"><textarea class="post-info-text" placeholder="comment on this post" id="user-comment-text" ng-model="acomment">{{acomment}}</textarea></div> <div class="col-md-12 col-xs-12"><button ng-click="makeComment()" id="post-btn"><img src="img/post.png" height="25" width="25"> post</button></div> </div>  </div></div>'+_),n},k=function(e){return 0!=e&&void 0!=e&&null!=e&&""!=e?!0:!1};return{restrict:"EAC",scope:{index:"=",showshare:"&"},controller:["$scope","$element",function(l,r){function f(){if(l.content){if($("#explanation-text-single").hide(),$("#question-explanation-img").hide(),l.explanation_image="",l.explanation="",0==$.isEmptyObject(l.content.comments)&&0!=l.content.comments&&""!=l.content.comments&&void 0!=l.content.comments){l.comments=[];for(var t=0;t<l.content.comments.length;t++){0==k(l.content.comments_user_info[t].picture_url)?l.content.comments_user_info[t].picture_url="img/default.png":a.isLoggedIn()&&l.content.comments[t].user_id==d.id&&(l.content.comments_user_info[t].picture_url=d.picture_url);var n=$.extend(l.content.comments[t],l.content.comments_user_info[t]);n.created=u(n.created),l.comments.push(n)}w()}else _="";if(null!=l.content.question&&""!=l.content.question){if(1==l.content.user_question_help.status?l.helpful_img="img/helpful.png":l.helpful_img="img/upvote.png",null!=l.content.question_interaction&&""!=l.content.question_interaction?(l.helpful_count=parseInt(l.content.question_interaction.helpful_count),l.share_count=parseInt(l.content.question_interaction.share_count),l.views_count=parseInt(l.content.question_interaction.views_count),l.comment_count=parseInt(l.content.question_interaction.comment_count)):(l.helpful_count=0,l.share_count=0,l.views_count=0,l.comment_count=0),null!=l.content.subject.icon_url&&""!=l.content.subject.icon_url&&(l.subject_img=l.content.subject.icon_url),null!=l.content.subject.name&&""!=l.content.subject.name&&(l.subject_name=l.content.subject.name),l.content.question.question&&(C(l.content.question.question,".png")?(l.image_question="images/SSCE/"+l.subject_name+"/QuestionImages"+l.content.question.question,l.is_image_question=!0):(l.is_image_question=!1,C(l.content.question.question,"?")?l.question="<b>"+l.content.question.question+" </b>":l.question="<b>"+l.content.question.question+"? </b>")),null!=l.content.question.optionA&&""!=l.content.question.optionA&&(l.optionA="<b>A.</b> "+l.content.question.optionA),null!=l.content.question.optionB&&""!=l.content.question.optionB&&(l.optionB="<b>B.</b> "+l.content.question.optionB),null!=l.content.question.optionC&&""!=l.content.question.optionC&&(l.optionC="<b>C.</b> "+l.content.question.optionC),null!=l.content.question.optionD&&""!=l.content.question.optionD&&(l.optionD="<b>D.</b> "+l.content.question.optionD),k(l.content.question.exam_type)&&(l.exam_type=l.content.question.exam_type,l.resource_path="images/"+l.exam_type+"/"+l.subject_name),null!=l.content.question.explanation&&""!=l.content.question.explanation&&(C(l.content.question.explanation,".png")?(l.explanation_image=l.resource_path+"/Explanations"+l.content.question.explanation,l.explanation="",$("#question-explanation-img").show(),$("#explanation-text-single").hide()):(l.explanation=l.content.question.explanation,l.explanation_image="",$("#question-explanation-img").hide(),$("#explanation-text-single").show())),k(l.content.question.answer)){l.answer_text="<b>The answer is "+l.content.question.answer+".  ";var i="";switch(l.content.question.answer){case"A":i=l.content.question.optionA;break;case"B":i=l.content.question.optionB;break;case"C":i=l.content.question.optionC;break;case"D":i=l.content.question.optionD}i+="</b>",i.match(/\d+(-)\d+(-)\D/g)?l.answer_text+="</b>":l.answer_text+=i}l.subject_color="rgb("+l.content.subject.color+")",l.llh_img="img/llh.png"}null!=l.content.question.image&&""!=l.content.question.image?(q=h,l.question_image=l.content.question.image):q=v,""!=l.content.discussion&&null!=l.content.discussion&&(l.discussion=l.content.discussion.discussion),a.isLoggedIn()?(l.isLoggedIn=!0,g=a.getUser(),g.picture_url?l.user_img=g.picture_url:l.user_img="img/default.png",l.user_name=g.firstname+" "+g.lastname,l.user_id=g.id,l.user_comment=""):l.isLoggedIn=!1,void 0!=l.content.owner&&(1==l.content.owner?(l.owner_image=l.llh_img,l.owner_name="Team LLH"):(l.content.owner.picture_url?l.content.owner.id==g.id?l.owner_image=l.user_img:l.owner_image=l.content.owner.picture_url:l.owner_image="img/default.png",l.owner_name=l.content.owner.firstname+" "+l.content.owner.lastname),l.created=l.content.datecreated),r.html(b(l.content.question,l.content.discussion)),e(r.contents())(l)}}if($("#spinner-div").hide(),a.isLoggedIn())var d=a.getUser();var m=function(){var e=c.getStorageValue("posts");e[l.index].question_interaction.share_count=parseInt(e[l.index].question_interaction.share_count)+1,c.setStorageValue("posts",[]),c.setStorageValue("posts",e)},p=function(){var e=c.getStorageValue("posts");e[l.index].question_interaction.helpful_count=parseInt(e[l.index].question_interaction.helpful_count)+1,e[l.index].user_question_help.status=1,c.setStorageValue("posts",[]),c.setStorageValue("posts",e)};l.incrementHelpful=function(){var e=l.content.user_question_help.status;1==e||1==e||(l.helpful_count+=1,l.content.question_interaction.helpful_count=parseInt(l.content.question_interaction.helpful_count)+1,l.content.user_question_help.status=1,l.helpful_img="img/helpful.png",i.setHelpful(l.content.postid,"I"),i.send().then(function(e){s.check(e.data)&&(0==e.data.data?(l.helpful_count-=1,l.content.question_interaction.helpful_count=parseInt(l.content.question_interaction.helpful_count)-1,l.content.user_question_help.status=0,l.helpful_img="img/upvote.png"):1==e.data.data&&p())},function(e){l.helpful_count-=1,l.content.question_interaction.helpful_count=parseInt(l.content.question_interaction.helpful_count)-1,l.content.user_question_help.status=0,l.helpful_img="img/upvote.png"}))},l.incrementShare=function(){l.share_count+=1,l.content.question_interaction.share_count=parseInt(l.content.question_interaction.share_count)+1,i.setShareCount(l.content.postid),i.send().then(function(e){s.check(e.data)&&(0==e.data.data&&(l.share_count-=1,l.content.question_interaction.share_count=parseInt(l.content.question_interaction.share_count)-1),1==e.data.data&&m(),l.showshare({pid:l.content.postid,subject:l.content.question.subject,question:l.content.question.question}))},function(e){l.share_count-=1,l.content.question_interaction.share_count=parseInt(l.content.question_interaction.share_count)-1})},l.acomment,l.current_editted_id=-1,l.isEdittedClicked=!1,l.edited_comment="",l.setEdittedClicked=function(e,t,n){a.isLoggedIn()?(l.current_editted_id=n,l.edited_comment=t,l.isEdittedClicked=e):$("#signinModal").modal("show")},l.unsetEdittedClicked=function(){a.isLoggedIn()?(l.current_editted_id=-1,l.edited_comment="",l.isEdittedClicked=!1):$("#signinModal").modal("show")},l.submitEditted=function(e,t){a.isLoggedIn()?e!=l.content.comments[l.current_editted_id].comment&&i.setEditComment(t,e)&&i.send().then(function(t){1==s.check(t.data)&&1==t.data.data&&(l.content.comments[l.current_editted_id].comment=e,f())},function(e){})["finally"](function(){l.current_editted_id=-1,l.edited_comment="",l.isEdittedClicked=!1}):$("#signinModal").modal("show")},l.closePost=function(){$("#singlePostModal").modal("hide"),l.content=null},l.showProfile=function(e){a.isLoggedIn()?(l.closePost(),n.go("user",{id:e})):$("#signinModal").modal("show")},l.getHtml=function(e){return t.trustAsHtml(e)},l.refreshComments=function(){if(a.isLoggedIn()){var e="",t=l.content.postid;k(l.content.comments)&&(e=l.content.comments[0].created),1==i.setLatestComments(e,t)&&($("#spinner-div").attr("class","show"),i.send().then(function(e){if(1==s.check(e.data)&&k(e.data.data)){l.content.comments=[],l.content.comments_user_info=[],l.content.comments=e.data.data[0],l.content.comments_user_info=e.data.data[1],0!=e.data.data[2]&&(l.content.question_interaction=e.data.data[2],l.helpful_count=parseInt(l.content.question_interaction.helpful_count),l.share_count=parseInt(l.content.question_interaction.share_count),l.views_count=parseInt(l.content.question_interaction.views_count),l.comment_count=parseInt(l.content.question_interaction.comment_count));var t=c.getStorageValue("posts");t[l.index].comments=l.content.comments,t[l.index].comments_user_info=l.content.comments_user_info,t[l.index].question_interaction=l.content.question_interaction,c.setStorageValue("posts",[]),c.setStorageValue("posts",t),f()}},function(e){console.log(e.data)}))}else $("#signinModal").modal("show")},l.makeComment=function(){var e=l.content.postid,t=null,o="";1==l.content.owner?(t=1,o="L"):(t=l.content.owner.id,o="S");var u="S",r=l.acomment;1==a.isLoggedIn()?r&&(l.comment_count+=1,l.content.question_interaction.comment_count=parseInt(l.content.question_interaction.comment_count)+1,i.setmakeComment(e,t,o,u,r)&&i.send().then(function(e){if(console.log(e.data),e.data.data&&1==s.check(e.data)){l.content.comments?l.content.comments.splice(0,0,e.data.data):l.content.comments[0]=e.data.data,null!=l.content.comments_user_info?l.content.comments_user_info.splice(0,0,{firstname:d.firstname,lastname:d.lastname,picture_url:d.picture_url}):(l.content.comments_user_info=new Array,l.content.comments_user_info[0]={firstname:d.firstname,lastname:d.lastname,picture_url:d.picture_url});var i=c.getStorageValue("posts");i[l.index].comments=[],i[l.index].comments_user_info=[],i[l.index].comments=l.content.comments,i[l.index].comments_user_info=l.content.comments_user_info,i[l.index].question_interaction.comment_count=l.content.question_interaction.comment_count,c.setStorageValue("posts",[]),c.setStorageValue("posts",i),f(),l.acomment=""}else l.comment_count-=1,l.content.question_interaction.comment_count=parseInt(l.content.question_interaction.comment_count)-1},function(e){l.comment_count-=1,l.content.question_interaction.comment_count=parseInt(scope.content.question_interaction.comment_count)-1})):n.go("login"),l.acomment=""},l.$on("postchange",function(){if("Single"==o.getTo()){l.content=o.getPost();try{if($("#explanation-text-single").hide(),$("#question-explanation-img").hide(),l.explanation_image="",l.explanation="",k(l.content.comments)){l.comments=[];for(var t=0;t<l.content.comments.length;t++){0==k(l.content.comments_user_info[t].picture_url)?l.content.comments_user_info[t].picture_url="img/default.png":a.isLoggedIn()&&l.content.comments[t].user_id==d.id&&(l.content.comments_user_info[t].picture_url=d.picture_url);var n=$.extend(l.content.comments[t],l.content.comments_user_info[t]);n.created=u(n.created),l.comments.push(n)}w()}else _="";if(null!=l.content.question&&""!=l.content.question){if(1==l.content.user_question_help.status?l.helpful_img="img/helpful.png":l.helpful_img="img/upvote.png",null!=l.content.question_interaction&&""!=l.content.question_interaction?(l.helpful_count=parseInt(l.content.question_interaction.helpful_count),l.share_count=parseInt(l.content.question_interaction.share_count),l.views_count=parseInt(l.content.question_interaction.views_count),l.comment_count=parseInt(l.content.question_interaction.comment_count)):(l.helpful_count=0,l.share_count=0,l.views_count=0,l.comment_count=0),null!=l.content.subject.icon_url&&""!=l.content.subject.icon_url&&(l.subject_img=l.content.subject.icon_url),null!=l.content.subject.name&&""!=l.content.subject.name&&(l.subject_name=l.content.subject.name),l.content.question.question&&(C(l.content.question.question,".png")?(l.image_question="images/SSCE/"+l.subject_name+"/QuestionImages"+l.content.question.question,l.is_image_question=!0):(l.is_image_question=!1,C(l.content.question.question,"?")?l.question="<b>"+l.content.question.question+" </b>":l.question="<b>"+l.content.question.question+"? </b>")),null!=l.content.question.optionA&&""!=l.content.question.optionA&&(l.optionA="<b>A.</b> "+l.content.question.optionA),null!=l.content.question.optionB&&""!=l.content.question.optionB&&(l.optionB="<b>B.</b> "+l.content.question.optionB),null!=l.content.question.optionC&&""!=l.content.question.optionC&&(l.optionC="<b>C.</b> "+l.content.question.optionC),null!=l.content.question.optionD&&""!=l.content.question.optionD&&(l.optionD="<b>D.</b> "+l.content.question.optionD),k(l.content.question.exam_type)&&(l.exam_type=l.content.question.exam_type,l.resource_path="images/"+l.exam_type+"/"+l.subject_name),null!=l.content.question.explanation&&""!=l.content.question.explanation&&(C(l.content.question.explanation,".png")?(l.explanation_image=l.resource_path+"/Explanations"+l.content.question.explanation,$("#question-explanation-img").show(),$("#explanation-text-single").hide()):(l.explanation=l.content.question.explanation,$("#question-explanation-img").hide(),$("#explanation-text-single").show())),k(l.content.question.answer)){l.answer_text="<b>The answer is "+l.content.question.answer+".  ";var i="";switch(l.content.question.answer){case"A":i=l.content.question.optionA;break;case"B":i=l.content.question.optionB;break;case"C":i=l.content.question.optionC;break;case"D":i=l.content.question.optionD}i+="</b>",i.match(/\d+(-)\d+(-)\D/g)?l.answer_text+="</b>":l.answer_text+=i}l.subject_color="rgb("+l.content.subject.color+")",l.llh_img="img/llh.png"}null!=l.content.question.image&&""!=l.content.question.image?(q=h,l.question_image=l.content.question.image):q=v,""!=l.content.discussion&&null!=l.content.discussion&&(l.discussion=l.content.discussion.discussion),a.isLoggedIn()?(l.isLoggedIn=!0,g=a.getUser(),g.picture_url?l.user_img=g.picture_url:l.user_img="img/default.png",l.user_name=g.firstname+" "+g.lastname,l.user_id=g.id,l.user_comment=""):l.isLoggedIn=!1,void 0!=l.content.owner&&(1==l.content.owner?(l.owner_image=l.llh_img,l.owner_name="Team LLH"):(l.content.owner.picture_url?l.content.owner.id==g.id?l.owner_image=l.user_img:l.owner_image=l.content.owner.picture_url:l.owner_image="img/default.png",l.owner_name=l.content.owner.firstname+" "+l.content.owner.lastname),l.created=l.content.datecreated),r.html(b(l.content.question,l.content.discussion)),e(r.contents())(l)}catch(s){}}})}]}}]);